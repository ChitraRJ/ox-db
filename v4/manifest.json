{
  "release": "4",
  "tasks": [
    {
      "name": "init",
      "description": "create the database for the first time",
      "actions": ["create-db", "install-extensions"]
    },
    {
      "name": "deploy",
      "description": "create the tables and functions",
      "actions": ["deploy-schema", "deploy-fxs"]
    },
    {
      "name": "upgrade",
      "description": "upgrade the database to the specified version",
      "actions": ["drop-fxs", "upgrade-schema", "deploy-fxs"]
    },
    {
      "name": "install",
      "description": "install the database from scratch",
      "tasks": ["init","deploy"]
    }
  ],
  "actions": [
    {
      "name": "create-db",
      "description": "creates the database and user",
      "transactional": false,
      "asAdmin": true,
      "useDb": false,
      "scripts": [
        {
          "name": "create the database",
          "file": "db.sql",
          "vars": [
            {
              "name": "<DB_NAME>",
              "from": "Db.Name"
            }
          ]
        },
        {
          "name": "create the database user",
          "file": "user.sql",
          "content": "saa",
          "vars": [
            {
              "name": "<DB_USER>",
              "from": "Db.Username"
            },
            {
              "name": "<DB_PWD>",
              "from": "Db.Password"
            }
          ]
        }
      ]
    },
    {
      "name": "install-extensions",
      "description": "installs the database extensions",
      "transactional": true,
      "asAdmin": true,
      "useDb": true,
      "scripts": [
        {
          "name": "install hstore extension",
          "file": "hstore.sql",
          "vars": []
        },
        {
          "name": "install intarray extension",
          "file": "intarray.sql",
          "vars": []
        }
      ]
    },
    {
      "name": "deploy-schema",
      "description": "deploy schemas",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "sql tables",
          "file": "tables.sql",
          "vars": []
        }
      ]
    },
    {
      "name": "deploy-fxs",
      "description": "deploy functions",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "json schema validation",
          "file": "json.sql",
          "vars": []
        },
        {
          "name": "general data validation",
          "file": "validation.sql",
          "vars": []
        },
        {
          "name": "set functions",
          "file": "set.sql",
          "vars": []
        },
        {
          "name": "get functions",
          "file": "get.sql",
          "vars": []
        },
        {
          "name": "delete functions",
          "file": "delete.sql",
          "vars": []
        },
        {
          "name": "general queries",
          "file": "queries.sql",
          "vars": []
        },
        {
          "name": "tree management",
          "file": "tree.sql",
          "vars": []
        },
        {
          "name": "tagging",
          "file": "tags.sql",
          "vars": []
        },
        {
          "name": "encryption",
          "file": "keyman.sql",
          "vars": []
        }
      ]
    },
    {
      "name": "drop-fxs",
      "description": "drop functions",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "drop existing functions",
          "file": "dropfxs.sql",
          "vars": [
            {
              "name": "<FX_PREFIX>",
              "value": "ox_*"
            }
          ]
        }
      ]
    },
    {
      "name": "upgrade",
      "description": "upgrade the database",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "drop functions",
          "file": "dropfxs.sql",
          "vars": [
            {
              "name": "<FX_FILTER>",
              "value": "ox_*"
            }
          ]
        },
        {
          "name": "upgrade tables",
          "file": "upgrade.sql",
          "vars": []
        }
      ]
    }
  ]
}