{
  "dbVersion": "4",
  "description": "database release 4",
  "commandsPath" : "command",
  "queriesPath" : "query",
  "dbProvider": "pgsql",
  "commands": [
    {
      "name": "init",
      "description": "create the database for the first time",
      "actions": [
        "create-db",
        "install-extensions",
        "create-version-table"
      ]
    },
    {
      "name": "deploy",
      "description": "create the tables and functions",
      "actions": [
        "deploy-schema",
        "deploy-fxs",
        "update-release-version"
      ]
    },
    {
      "name": "upgrade",
      "description": "upgrade the database to the specified version",
      "actions": [
        "drop-fxs",
        "upgrade-schema",
        "deploy-fxs",
        "update-release-version"
      ]
    },
    {
      "name": "install",
      "description": "install the database from scratch",
      "commands": [
        "init",
        "deploy"
      ]
    }
  ],
  "actions": [
    {
      "name": "create-db",
      "description": "creates the database and user",
      "transactional": false,
      "asAdmin": true,
      "useDb": false,
      "scripts": [
        {
          "name": "create the database",
          "file": "db.sql",
          "vars": [
            {
              "name": "<DB_NAME>",
              "fromConf": "Db.Name"
            }
          ]
        },
        {
          "name": "create the database user",
          "file": "user.sql",
          "vars": [
            {
              "name": "<DB_USER>",
              "fromConf": "Db.Username"
            },
            {
              "name": "<DB_PWD>",
              "fromConf": "Db.Password"
            }
          ]
        }
      ]
    },
    {
      "name": "install-extensions",
      "description": "installs the database extensions",
      "transactional": true,
      "asAdmin": true,
      "useDb": true,
      "scripts": [
        {
          "name": "install hstore extension",
          "file": "hstore.sql",
          "vars": []
        },
        {
          "name": "install intarray extension",
          "file": "intarray.sql",
          "vars": []
        }
      ]
    },
    {
      "name": "create-version-table",
      "description": "create version tracking table",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "deploy-version-table",
          "file": "version_table.sql",
          "vars": []
        }
      ]
    },
    {
      "name": "update-release-version",
      "description": "update release information in version tracking table",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "update-version",
          "file": "update_version.sql",
          "vars": [
            {
              "name": "<APP_VERSION>",
              "fromContext": "AppVersion"
            },
            {
              "name": "<DB_VERSION>",
              "fromContext": "DbVersion"
            },
            {
              "name": "<SOURCE>",
              "fromConf": "Schema.URI"
            }
          ]
        }
      ]
    },
    {
      "name": "deploy-schema",
      "description": "deploy schemas",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "sql tables",
          "file": "tables.sql",
          "vars": []
        }
      ]
    },
    {
      "name": "deploy-fxs",
      "description": "deploy functions",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "json schema validation",
          "file": "json.sql",
          "vars": []
        },
        {
          "name": "general data validation",
          "file": "validation.sql",
          "vars": []
        },
        {
          "name": "set functions",
          "file": "set.sql",
          "vars": []
        },
        {
          "name": "get functions",
          "file": "get.sql",
          "vars": []
        },
        {
          "name": "delete functions",
          "file": "delete.sql",
          "vars": []
        },
        {
          "name": "general queries",
          "file": "queries.sql",
          "vars": []
        },
        {
          "name": "tree management",
          "file": "tree.sql",
          "vars": []
        },
        {
          "name": "tagging",
          "file": "tags.sql",
          "vars": []
        },
        {
          "name": "encryption",
          "file": "keyman.sql",
          "vars": []
        }
      ]
    },
    {
      "name": "drop-fxs",
      "description": "drop functions",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "drop existing functions",
          "file": "dropfxs.sql",
          "vars": [
            {
              "name": "<FX_PREFIX>",
              "value": "ox_*"
            }
          ]
        }
      ]
    },
    {
      "name": "upgrade",
      "description": "upgrade the database",
      "transactional": true,
      "asAdmin": false,
      "useDb": true,
      "scripts": [
        {
          "name": "drop functions",
          "file": "dropfxs.sql",
          "vars": [
            {
              "name": "<FX_FILTER>",
              "fromValue": "ox_*"
            }
          ]
        },
        {
          "name": "upgrade tables",
          "file": "upgrade.sql",
          "vars": []
        }
      ]
    }
  ],
  "queries": [
    {
      "name": "versions",
      "description": "get the information in the version tracking table",
      "file": "get_version_history.sql",
      "input": [
      ],
      "output": [
        {
          "name": "appVersion",
          "description": "the application version",
          "type": "string"
        },
        {
          "name": "dbVersion",
          "description": "the database version",
          "type": "string"
        },
        {
          "name": "time",
          "description": "the release date and time",
          "type": "date"
        },
        {
          "name": "origin",
          "description": "the source of the release scripts used",
          "type": "string"
        }
      ]
    },
    {
      "name": "current-version",
      "description": "get the current application and database version",
      "file": "get_current_version.sql",
      "input": [
      ],
      "output": [
        {
          "name": "appVersion",
          "description": "the application version",
          "type": "string"
        },
        {
          "name": "dbVersion",
          "description": "the database version",
          "type": "string"
        }
      ]
    },
    {
      "name": "db-version",
      "description": "get the database version for the specified application version",
      "file": "get_db_version.sql",
      "input": [
        {
          "name": "appVersion",
          "description": "the application version",
          "type": "string"
        }
      ],
      "output": [
        {
          "name": "dbVersion",
          "description": "the database version",
          "type": "string"
        }
      ]
    }
  ]
}
